#include "weatherplugin.h"

#include "../utils.h"
#include "position.h"
#include "weatherdata.h"

#include <QDebug>

bool isSimiliar(const QString &string, const QString &other, double similarityFactor = 0.8)
{
    return strings::calculateSimilarity(string.mid(0, other.length()), other) >= similarityFactor;
}

bool WeatherPlugin::isValid(const QString &text)
{
    if (isSimiliar(text, tr("what's the weather")))
        return true;

    if (isSimiliar(text, tr("what is the weather")))
        return true;

    if (isSimiliar(text, tr("how's the weather")))
        return true;

    if (isSimiliar(text, tr("tell me about the weather")))
        return true;

    if (isSimiliar(text, tr("is it going to rain")))
        return true;

    if (isSimiliar(text, tr("is it sunny today")))
        return true;

    if (isSimiliar(text, tr("will it be hot")))
        return true;

    if (isSimiliar(text, tr("is there a chance of thunderstorms")))
        return true;

    if (isSimiliar(text, tr("how cold is it outside")))
        return true;

    return false; // No weather-related phrases found
}

void WeatherPlugin::run(const QString &text)
{
    // TODO: Implement the logic for handling the weather request
    // You can use the provided 'text' parameter to determine the specific weather action to take
    // For example, you could make an API call to retrieve weather data and display it to the user
    // or perform any other relevant operations.
    // Ensure that the function implementation is consistent with your application's requirements.

    WeatherData data;
    data.parseWeatherData(
        R"({"latitude":51.06,"longitude":13.74,"generationtime_ms":1.8320083618164062,"utc_offset_seconds":7200,"timezone":"Europe/Berlin","timezone_abbreviation":"CEST","elevation":116.0,"current_weather":{"temperature":22.7,"windspeed":10.9,"winddirection":98.0,"weathercode":3,"is_day":1,"time":"2023-05-22T20:00"},"hourly_units":{"time":"iso8601","temperature_2m":"°C","apparent_temperature":"°C","weathercode":"wmo code","windspeed_10m":"km/h","winddirection_10m":"°","relativehumidity_2m":"%","visibility":"m","is_day":""},"hourly":{"time":["2023-05-22T00:00","2023-05-22T01:00","2023-05-22T02:00","2023-05-22T03:00","2023-05-22T04:00","2023-05-22T05:00","2023-05-22T06:00","2023-05-22T07:00","2023-05-22T08:00","2023-05-22T09:00","2023-05-22T10:00","2023-05-22T11:00","2023-05-22T12:00","2023-05-22T13:00","2023-05-22T14:00","2023-05-22T15:00","2023-05-22T16:00","2023-05-22T17:00","2023-05-22T18:00","2023-05-22T19:00","2023-05-22T20:00","2023-05-22T21:00","2023-05-22T22:00","2023-05-22T23:00","2023-05-23T00:00","2023-05-23T01:00","2023-05-23T02:00","2023-05-23T03:00","2023-05-23T04:00","2023-05-23T05:00","2023-05-23T06:00","2023-05-23T07:00","2023-05-23T08:00","2023-05-23T09:00","2023-05-23T10:00","2023-05-23T11:00","2023-05-23T12:00","2023-05-23T13:00","2023-05-23T14:00","2023-05-23T15:00","2023-05-23T16:00","2023-05-23T17:00","2023-05-23T18:00","2023-05-23T19:00","2023-05-23T20:00","2023-05-23T21:00","2023-05-23T22:00","2023-05-23T23:00","2023-05-24T00:00","2023-05-24T01:00","2023-05-24T02:00","2023-05-24T03:00","2023-05-24T04:00","2023-05-24T05:00","2023-05-24T06:00","2023-05-24T07:00","2023-05-24T08:00","2023-05-24T09:00","2023-05-24T10:00","2023-05-24T11:00","2023-05-24T12:00","2023-05-24T13:00","2023-05-24T14:00","2023-05-24T15:00","2023-05-24T16:00","2023-05-24T17:00","2023-05-24T18:00","2023-05-24T19:00","2023-05-24T20:00","2023-05-24T21:00","2023-05-24T22:00","2023-05-24T23:00","2023-05-25T00:00","2023-05-25T01:00","2023-05-25T02:00","2023-05-25T03:00","2023-05-25T04:00","2023-05-25T05:00","2023-05-25T06:00","2023-05-25T07:00","2023-05-25T08:00","2023-05-25T09:00","2023-05-25T10:00","2023-05-25T11:00","2023-05-25T12:00","2023-05-25T13:00","2023-05-25T14:00","2023-05-25T15:00","2023-05-25T16:00","2023-05-25T17:00","2023-05-25T18:00","2023-05-25T19:00","2023-05-25T20:00","2023-05-25T21:00","2023-05-25T22:00","2023-05-25T23:00","2023-05-26T00:00","2023-05-26T01:00","2023-05-26T02:00","2023-05-26T03:00","2023-05-26T04:00","2023-05-26T05:00","2023-05-26T06:00","2023-05-26T07:00","2023-05-26T08:00","2023-05-26T09:00","2023-05-26T10:00","2023-05-26T11:00","2023-05-26T12:00","2023-05-26T13:00","2023-05-26T14:00","2023-05-26T15:00","2023-05-26T16:00","2023-05-26T17:00","2023-05-26T18:00","2023-05-26T19:00","2023-05-26T20:00","2023-05-26T21:00","2023-05-26T22:00","2023-05-26T23:00","2023-05-27T00:00","2023-05-27T01:00","2023-05-27T02:00","2023-05-27T03:00","2023-05-27T04:00","2023-05-27T05:00","2023-05-27T06:00","2023-05-27T07:00","2023-05-27T08:00","2023-05-27T09:00","2023-05-27T10:00","2023-05-27T11:00","2023-05-27T12:00","2023-05-27T13:00","2023-05-27T14:00","2023-05-27T15:00","2023-05-27T16:00","2023-05-27T17:00","2023-05-27T18:00","2023-05-27T19:00","2023-05-27T20:00","2023-05-27T21:00","2023-05-27T22:00","2023-05-27T23:00","2023-05-28T00:00","2023-05-28T01:00","2023-05-28T02:00","2023-05-28T03:00","2023-05-28T04:00","2023-05-28T05:00","2023-05-28T06:00","2023-05-28T07:00","2023-05-28T08:00","2023-05-28T09:00","2023-05-28T10:00","2023-05-28T11:00","2023-05-28T12:00","2023-05-28T13:00","2023-05-28T14:00","2023-05-28T15:00","2023-05-28T16:00","2023-05-28T17:00","2023-05-28T18:00","2023-05-28T19:00","2023-05-28T20:00","2023-05-28T21:00","2023-05-28T22:00","2023-05-28T23:00"],"temperature_2m":[17.8,16.4,15.5,14.8,14.3,13.3,13.1,13.9,16.0,19.0,21.8,24.6,25.4,25.9,26.0,26.3,26.3,26.2,25.6,24.3,22.7,21.0,19.2,17.9,17.3,16.6,16.1,16.0,15.6,15.2,15.2,15.5,16.7,15.2,16.3,17.7,17.7,18.5,18.3,18.8,20.2,18.0,16.9,16.5,15.6,14.8,14.6,14.3,14.1,13.7,13.1,12.1,11.1,10.0,9.2,8.9,9.0,9.6,10.7,11.5,12.5,13.7,14.6,15.8,16.7,17.3,16.2,16.0,15.4,14.1,12.5,11.3,10.6,9.9,9.4,9.0,8.6,8.4,8.3,9.7,12.1,13.7,15.4,16.9,18.0,18.8,19.4,20.0,20.4,20.2,20.1,19.6,18.6,17.6,16.3,15.2,14.4,13.7,12.9,11.7,10.4,9.6,9.6,10.2,11.1,12.5,14.2,15.8,17.0,18.1,19.0,19.6,20.0,20.1,19.7,18.9,17.9,16.5,14.9,13.4,12.3,11.3,10.5,9.6,8.8,8.6,9.2,10.4,11.9,13.8,16.0,17.8,19.2,20.3,21.0,21.2,21.5,21.5,21.2,20.5,19.4,17.6,15.4,13.3,11.7,10.2,9.0,7.7,6.7,6.8,8.5,11.2,13.9,16.4,18.9,20.9,22.3,23.2,23.9,24.5,24.9,25.0,24.6,23.7,22.4,20.4,17.8,15.6],"apparent_temperature":[18.3,16.8,16.2,15.3,14.7,13.5,13.1,14.0,16.2,18.9,22.0,24.7,24.6,25.1,25.2,25.9,25.4,24.6,23.8,22.3,21.1,20.2,18.8,17.6,17.1,17.0,16.7,16.3,16.0,14.7,15.5,15.8,17.2,15.6,17.3,17.2,16.4,17.1,17.0,17.4,18.2,16.0,15.3,14.8,14.1,12.7,12.8,12.0,12.4,11.5,10.3,8.8,7.9,6.7,5.9,5.7,5.9,6.4,7.2,8.2,9.3,10.7,12.0,13.7,14.4,14.3,13.5,13.6,13.4,12.7,11.0,9.8,9.3,8.6,8.1,7.7,7.4,7.1,6.9,8.6,10.6,12.1,14.3,16.0,16.8,17.4,17.2,18.3,18.1,17.9,17.6,17.3,16.8,16.1,15.2,14.3,13.4,12.5,11.5,10.1,8.8,7.9,7.8,8.2,9.0,10.2,11.8,13.8,15.5,16.7,17.4,17.8,17.7,17.1,16.4,15.8,15.2,14.3,13.3,12.1,11.1,10.1,9.2,8.4,7.7,7.4,8.1,9.3,10.9,12.9,15.0,17.4,19.1,20.1,20.6,20.6,20.4,19.8,19.2,18.8,17.9,16.3,14.3,12.2,10.5,9.1,7.7,6.3,5.1,5.2,7.3,10.5,13.6,16.0,18.1,20.6,22.5,24.0,25.0,25.4,25.1,24.4,23.4,22.5,21.3,19.3,17.0,14.8],"weathercode":[1,1,3,3,2,3,2,2,3,3,3,3,3,3,3,2,3,3,2,2,3,2,3,3,3,3,80,61,61,95,3,80,80,95,81,3,3,3,3,3,3,3,61,3,61,3,3,3,80,80,61,3,3,3,3,3,3,3,3,3,3,3,2,2,2,1,3,2,0,0,1,2,3,3,1,2,3,1,2,2,0,0,1,2,2,2,3,1,3,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0],"windspeed_10m":[2.5,3.4,1.5,2.4,2.8,2.9,2.8,1.8,0.8,4.1,5.5,7.3,10.8,13.4,14.4,13.4,14.4,13.8,13.8,13.4,10.9,6.0,4.7,4.0,3.9,1.8,2.2,3.3,3.5,6.9,2.4,3.3,5.4,5.4,1.8,11.6,18.0,16.3,16.3,13.2,17.0,18.7,16.3,16.6,15.3,16.3,14.5,15.9,13.0,14.2,15.2,16.5,15.1,14.1,13.1,12.8,12.1,12.8,14.2,13.0,12.7,13.4,12.3,11.5,10.1,11.4,8.4,7.4,5.4,3.1,4.0,3.6,2.9,2.4,2.6,1.6,1.8,1.6,2.9,1.3,5.0,7.4,7.1,8.7,9.3,9.5,11.2,9.7,10.6,9.8,10.4,10.0,8.4,7.4,6.3,5.2,4.7,4.6,4.7,4.5,4.0,4.0,5.0,6.5,7.7,8.9,10.2,11.3,11.7,11.8,11.8,11.8,11.4,11.2,10.2,9.4,7.9,6.1,4.0,2.6,1.8,1.5,1.6,1.5,1.3,1.8,1.9,1.8,1.5,1.6,2.6,4.2,5.6,6.8,7.7,9.9,10.2,9.9,8.9,7.4,5.8,4.7,4.0,4.0,4.1,3.8,4.1,4.3,4.1,4.1,3.6,2.8,2.3,2.7,3.7,4.4,4.4,4.1,3.8,3.7,4.0,4.1,4.7,5.6,6.1,5.4,3.8,3.3],"winddirection_10m":[98,108,104,117,130,120,140,79,153,142,113,81,75,84,86,85,91,84,83,84,98,115,94,117,124,143,261,131,156,137,333,103,278,290,259,296,303,298,276,287,287,286,292,300,294,311,300,303,298,306,306,306,303,302,302,302,300,292,294,294,295,301,302,302,305,332,335,331,323,291,275,276,263,243,214,207,217,207,187,326,300,299,300,322,324,323,327,329,325,324,326,334,335,337,336,335,328,315,302,299,297,297,300,304,307,313,318,323,326,329,333,337,342,345,350,353,357,357,350,344,349,14,27,14,326,307,292,281,284,333,16,31,45,58,62,57,58,57,58,61,68,81,100,117,128,131,135,138,142,142,143,140,129,113,101,99,99,105,107,101,90,75,58,45,40,48,73,103],"relativehumidity_2m":[73,79,85,87,88,91,87,83,71,62,57,47,39,38,38,38,40,39,39,40,44,50,58,63,67,74,81,80,83,79,81,83,84,89,86,78,78,70,72,63,57,68,75,76,80,77,79,75,78,74,69,68,70,69,70,73,73,69,64,60,57,53,48,45,42,40,43,46,50,58,66,70,74,77,79,81,83,84,85,81,71,68,66,60,53,47,44,42,39,41,40,43,49,55,62,67,68,68,68,70,73,75,75,74,71,65,58,51,45,39,35,32,30,30,31,33,37,45,55,63,67,69,72,77,83,85,83,77,71,64,57,51,46,42,39,43,41,41,41,43,46,53,62,70,77,84,89,93,95,95,92,86,78,66,52,41,37,37,37,36,34,34,35,38,42,48,56,63],"visibility":[24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,4840.00,23680.00,15120.00,24140.00,24140.00,24140.00,24140.00,23780.00,16840.00,24140.00,24140.00,24140.00,21200.00,22180.00,24140.00,22860.00,22600.00,23320.00,24140.00,24140.00,24120.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00,24140.00],"is_day":[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0]},"daily_units":{"time":"iso8601","temperature_2m_max":"°C","temperature_2m_min":"°C","sunrise":"iso8601","sunset":"iso8601","uv_index_max":""},"daily":{"time":["2023-05-22","2023-05-23","2023-05-24","2023-05-25","2023-05-26","2023-05-27","2023-05-28"],"temperature_2m_max":[26.3,20.2,17.3,20.4,20.1,21.5,25.0],"temperature_2m_min":[13.1,14.3,8.9,8.3,9.6,8.6,6.7],"sunrise":["2023-05-22T05:03","2023-05-23T05:02","2023-05-24T05:01","2023-05-25T05:00","2023-05-26T04:59","2023-05-27T04:58","2023-05-28T04:57"],"sunset":["2023-05-22T20:59","2023-05-23T21:00","2023-05-24T21:02","2023-05-25T21:03","2023-05-26T21:04","2023-05-27T21:05","2023-05-28T21:07"],"uv_index_max":[6.75,2.55,6.50,6.75,6.25,6.70,6.55]}})");
    qDebug() << data;

    double latitude = 0;
    double longitude = 0;
    Position::getCityPosition(u"Dresden", &latitude, &longitude);
    qDebug().noquote() << "Dresden: Latitude:" << latitude << "longitude:" << longitude;
    bridge->say(tr("I don't know. This is not implemented yet."));
}
